<div
  x-data="{ showContraModal: false, activeContraText: '', activeContraName: '' }"
  x-init="const prevOverflow = document.body.style.overflow; $watch('showContraModal', (value) => { document.body.style.overflow = value ? 'hidden' : prevOverflow })"
>
  <div class="container mx-auto px-4 max-w-8xl {% if section.settings.space_bottom %}mb-12{% endif %}">
    {%- if section.settings.enable_dropdown -%}
      <div
        x-data="{ open: {{ section.settings.open_by_default | json }} }"
        class="overflow-hidden border-t-2"
      >
        <!-- Dropdown Header -->
        <button
          type="button"
          @click="open = !open"
          class="
            group relative w-full flex items-start gap-3 px-2 md:px-0 md:pr-2 py-4 text-left hover:bg-(--color-brand-secondary) active:bg-(--color-brand-secondary) transition-colors cursor-pointer
            focus-visible:ring-1 focus-visible:ring-insetc
          "
          :class="open ? 'bg-(--color-brand-secondary)' : ''"
          :aria-expanded="open.toString()"
          :aria-label="open ? '{{ 'general.accordion.close_section' | t }}' : '{{ 'general.accordion.open_section' | t }}'"
        >
          <h3 class="flex-1 min-w-0 text-xl md:text-4xl leading-tight wrap-break-words">
            {{ section.settings.title }}
          </h3>

          <!-- Icon wrapper -->
          <span
            class="
              flex-none shrink-0 ml-2 inline-flex h-9 w-9 aspect-square items-center justify-center rounded-full border border-(--color-brand-secondary) transition-colors select-none
              group-hover:bg-(--color-brand-primary) group-hover:text-white
            "
            :class="open ? 'bg-(--color-brand-primary) text-white' : 'bg-(--color-brand-secondary) text-(--color-brand-primary)'"
          >
            <!-- Plus -->
            <svg
              x-cloak
              x-show="!open"
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.8"
              aria-hidden="true"
            >
              <path stroke-linecap="round" d="M12 5v14M5 12h14" />
            </svg>
            <!-- Minus -->
            <svg
              x-cloak
              x-show="open"
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 pointer-events-none"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.8"
              aria-hidden="true"
            >
              <path stroke-linecap="round" d="M5 12h14" />
            </svg>
          </span>
        </button>

        <!-- Dropdown Body -->
        <div
          x-cloak
          x-show="open"
          x-transition:enter="transition ease-out duration-200"
          x-transition:enter-start="opacity-0 -translate-y-2"
          x-transition:enter-end="opacity-100 translate-y-0"
          x-transition:leave="transition ease-in duration-150"
          x-transition:leave-start="opacity-100 translate-y-0"
          x-transition:leave-end="opacity-0 -translate-y-2"
          class="px-2 my-4 space-y-2"
        >
          {%- if section.settings.content != blank -%}
            <div class="rte mb-6">{{ section.settings.content }}</div>
          {%- endif -%}

          {%- assign apply_url_fallback = section.settings.apply_url | default: pages['appointment-booking'].url -%}

          {% render 'procedure-table',
            services: section.blocks,
            disclaimer: section.settings.disclaimer,
            apply_url_default: apply_url_fallback,
            apply_cta: section.settings.apply_cta,
            label_procedure: section.settings.label_procedure,
            label_description: section.settings.label_description,
            label_price: section.settings.label_price,
            label_duration: section.settings.label_duration,
            label_contraindications: section.settings.label_contraindications
          %}
        </div>
      </div>
    {%- else -%}
      {%- if section.settings.title != blank -%}
        <h2 class="text-xl md:text-4xl leading-tight wrap-break-words mb-6">{{ section.settings.title }}</h2>
      {%- endif -%}

      {%- if section.settings.content != blank -%}
        <div class="rte mb-6">{{ section.settings.content }}</div>
      {%- endif -%}

      {%- assign apply_url_fallback = section.settings.apply_url | default: '#' -%}

      {% render 'procedure-table',
        services: section.blocks,
        disclaimer: section.settings.disclaimer,
        apply_url_default: apply_url_fallback,
        apply_cta: section.settings.apply_cta,
        label_procedure: section.settings.label_procedure,
        label_description: section.settings.label_description,
        label_price: section.settings.label_price,
        label_duration: section.settings.label_duration,
        label_contraindications: section.settings.label_contraindications
      %}
    {%- endif -%}
  </div>

  <!-- Contraindications Modal -->
  <div
    x-show="showContraModal"
    x-cloak
    @click.self="showContraModal = false"
    class="fixed inset-0 z-51 flex items-center justify-center bg-black/50 px-4 py-8"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    style="display: none;"
  >
    <div
      class="bg-(--color-brand-secondary) rounded-4xl shadow-xl w-full md:max-w-3xl max-w-lg transform relative"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0 scale-95"
      x-transition:enter-end="opacity-100 scale-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100 scale-100"
      x-transition:leave-end="opacity-0 scale-95"
      @click.stop
    >
      <!-- Close Button -->
      <button
        @click="showContraModal = false"
        class="
          absolute top-8 right-8 size-8 rounded-full bg-(--color-brand-primary) flex items-center justify-center group
          text-white border border-(--color-brand-primary)
          hover:bg-white hover:text-(--color-brand-primary)
          active:bg-white active:text-(--color-brand-primary)
          transition-all duration-300 z-50
        "
        aria-label="{{ 'general.modal.close' | t }}"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="currentColor"
          class="size-6 fill-(--color-brand-secondary) group-hover:fill-(--color-brand-primary) group-active:fill-(--color-brand-primary)"
        >
          <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
        </svg>
      </button>

      <!-- Modal Content -->
      <div class="p-8 md:p-12 space-y-6">
        <h2 class="text-xl md:text-3xl">{{ 'general.procedure_table.contraindications' | t }}</h2>
        <div class="rte" x-html="activeContraText"></div>
      </div>
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Procedūru tabula",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Virsraksts",
      "default": "Procedūras"
    },
    {
      "type": "richtext",
      "id": "content",
      "label": "Apraksts",
      "default": "<p></p>"
    },
    {
      "type": "text",
      "id": "disclaimer",
      "label": "Atruna zem tabulas",
      "info": "Parādās zem procedūru tabulas."
    },
    {
      "type": "url",
      "id": "apply_url",
      "label": "Pieteikšanās saite",
      "info": "Konsultācijas anketas vai procedūras saitei."
    },
    {
      "type": "text",
      "id": "apply_cta",
      "label": "Pieteikt poga teksts",
      "default": "Pieteikt"
    },
    {
      "type": "header",
      "content": "Tabulas kolonnu virsraksti"
    },
    {
      "type": "text",
      "id": "label_procedure",
      "label": "Procedūras kolonnas virsraksts",
      "default": "Procedūra"
    },
    {
      "type": "text",
      "id": "label_description",
      "label": "Apraksta kolonnas virsraksts",
      "default": "Apraksts"
    },
    {
      "type": "text",
      "id": "label_price",
      "label": "Cenas kolonnas virsraksts",
      "default": "Cena"
    },
    {
      "type": "text",
      "id": "label_duration",
      "label": "Ilguma kolonnas virsraksts",
      "default": "Ilgums"
    },
    {
      "type": "text",
      "id": "label_contraindications",
      "label": "Kontrindikāciju kolonnas virsraksts",
      "default": "Kontrindikācijas"
    },
    {
      "type": "checkbox",
      "id": "enable_dropdown",
      "label": "Iespējot dropdown",
      "info": "Padarīt sadaļu salocāmu ar +/- pogu.",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "open_by_default",
      "label": "Atvērt pēc noklusējuma",
      "info": "Dropdown būs atvērts sākumā (ja dropdown ir iespējots).",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "space_bottom",
      "label": "Atstarpe",
      "info": "Pievienot apakšējo atstarpi (mb-12) šai sadaļai.",
      "default": false
    }
  ],
  "blocks": [
    {
      "type": "procedure",
      "name": "Procedūra",
      "settings": [
        {
          "type": "text",
          "id": "procedure_name",
          "label": "Procedūras nosaukums",
          "default": "Sejas tīrīšana"
        },
        {
          "type": "textarea",
          "id": "procedure_description",
          "label": "Īss apraksts",
          "default": "Dziļa ādas tīrīšana ar tonizēšanu",
          "info": "Ieteicams līdz 7 vārdiem"
        },
        {
          "type": "text",
          "id": "procedure_price",
          "label": "Cena",
          "default": "€45"
        },
        {
          "type": "text",
          "id": "procedure_duration",
          "label": "Ilgums (min)",
          "default": "60"
        },
        {
          "type": "richtext",
          "id": "contraindications_text",
          "label": "Kontrindikācijas teksts",
          "info": "Teksts, kas parādīsies modalā",
          "default": "<p>Kontraindikācijas informācija šeit.</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Procedūru tabula"
    }
  ]
}
{% endschema %}
