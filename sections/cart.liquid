{% form 'cart', cart %}
  <div class="container mx-auto px-4 pt-24 pb-12">
    {% if cart.item_count > 0 %}
      <div data-cart-body>
        {%- assign back_to_store_text = 'cart.back_to_store' | t -%}
        {% render 'btn-brown', url: routes.all_products_collection_url, text: back_to_store_text %}
        <div class="flex items-center justify-between mb-6">
          <h1 class="hidden">{{ 'cart.heading' | t }}</h1>
        </div>

        <div class="overflow-x-auto md:overflow-visible">
          <table class="w-full table-auto border-separate border-spacing-y-12">
            <thead class="text-left shadow-md hidden md:table-header-group">
              <tr>
                <th class="px-6 py-3">{{ 'cart.product' | t }}</th>
                <th class="px-6 py-3 text-center">{{ 'cart.price' | t }}</th>
                <th class="px-6 py-3 text-center">{{ 'cart.quantity' | t }}</th>
                <th class="px-6 py-3 text-right">{{ 'cart.subtotal' | t }}</th>
              </tr>
            </thead>

            <tbody class="block md:table-row-group">
              {% for item in cart.items %}
                {%- assign max_qty = 9999 -%}
                {%- if item.variant.inventory_management and item.variant.inventory_policy == 'deny' -%}
                  {%- assign max_qty = item.variant.inventory_quantity | default: 0 | plus: 0 -%}
                  {%- if max_qty < 0 -%}
                    {%- assign max_qty = 0 -%}
                  {%- endif -%}
                {%- endif -%}
                <tr
                  class="relative overflow-hidden block md:table-row shadow-lg rounded-lg mb-4 md:mb-0 p-2 md:p-0 cart-line-item border border-gray-200 md:border-0"
                  data-key="{{ item.key }}"
                  data-max="{{ max_qty }}"
                >
                  <!-- Product -->
                  <td class="block md:table-cell px-6 py-4">
                    <div class="flex items-center gap-4">
                      {% render 'btn-remove-product', item: item %}
                      <a href="{{ item.url }}" class="flex items-center gap-4">
                        <img
                          src="{{ item.image | image_url: width: 100 }}"
                          alt="{{ item.product.title }}"
                          width="100"
                          height="100"
                          class="rounded"
                        >
                        <div class="flex flex-col">
                          <p class="font-medium">{{ item.product.title | truncatewords: 3 }}</p>
                          {% if item.variant and item.variant.title != 'Default Title' %}
                            <p class="text-xs text-gray-500 mt-1">
                              {{ item.variant.title }}
                            </p>
                          {% endif %}
                        </div>
                      </a>
                    </div>
                    <div class="mt-2 min-h-5">
                      <div
                        data-error
                        class="text-base text-red-600 text-left max-w-[320px] opacity-0 transition-opacity duration-300"
                      ></div>
                    </div>
                  </td>

                  <!-- Price with discount -->
                  <td class="block md:table-cell px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between md:block">
                      <span class="md:hidden">{{ 'cart.price' | t }}</span>
                      <div class="text-right md:text-center">
                        {%- if item.variant.compare_at_price > item.variant.price -%}
                          <div class="flex flex-col items-end md:items-center gap-1">
                            <span class="font-semibold text-sp-brown">{{ item.price | money }}</span>
                            <span class="text-xs line-through opacity-60">
                              {{- item.variant.compare_at_price | money -}}
                            </span>
                          </div>
                        {%- else -%}
                          <span>{{ item.price | money }}</span>
                        {%- endif -%}
                      </div>
                    </div>
                  </td>

                  <!-- Quantity -->
                  <td class="block md:table-cell px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between md:block">
                      <span class="md:hidden">{{ 'cart.quantity' | t }}</span>
                      <div class="quantity-container flex justify-end md:justify-center">
                        <div class="inline-flex items-center border rounded-2xl overflow-hidden w-fit">
                          <a
                            href="{{ routes.cart_change_url }}?line={{ forloop.index }}&quantity={{ item.quantity | minus: 1 }}"
                            class="link--no-underline quantity__button button quantity-minus px-2.5 py-1.5 hover:bg-sp-light-brown transition-colors cursor-pointer"
                            >âˆ’</a
                          >
                          <span data-qty class="w-8 text-center py-1.5 font-bold">{{ item.quantity }}</span>
                          <a
                            href="{{ routes.cart_change_url }}?line={{ forloop.index }}&quantity={{ item.quantity | plus: 1 }}"
                            class="link--no-underline quantity__button button quantity-plus px-2.5 py-1.5 hover:bg-sp-light-brown transition-colors cursor-pointer"
                            >+</a
                          >
                        </div>
                      </div>
                    </div>
                  </td>

                  <!-- Subtotal with discount -->
                  <td class="block md:table-cell px-6 py-4 text-right" data-line-price>
                    <div class="flex justify-between md:block">
                      <span class="md:hidden">{{ 'cart.subtotal' | t }}</span>
                      <div>
                        {%- assign line_compare_price = item.variant.compare_at_price | times: item.quantity -%}
                        {%- if item.variant.compare_at_price > item.variant.price -%}
                          <div class="flex flex-col items-end gap-1">
                            <span data-line-price-amount class="font-semibold text-sp-brown">
                              {{- item.final_line_price | money -}}
                            </span>
                            <span class="text-xs line-through opacity-60">{{ line_compare_price | money }}</span>
                          </div>
                        {%- else -%}
                          <span data-line-price-amount>{{ item.final_line_price | money }}</span>
                        {%- endif -%}
                      </div>
                    </div>

                    <!-- Row overlay -->
                    <div
                      data-row-overlay
                      class="hidden absolute inset-0 bg-white/60 z-10 flex items-center justify-center"
                      aria-hidden="true"
                    >
                      <span
                        class="inline-block h-4 w-4 rounded-full border-2 border-sp-brown border-t-transparent animate-spin"
                      ></span>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          <p class="text-gray-400">{{ 'cart.discount_note' | t }}</p>
        </div>
      </div>
    {% else %}
      <div class="h-60 md:h-120 mx-auto flex items-center justify-center">
        <div class="text-center">
          <h2 class="text-3xl my-4">{{ 'cart.empty' | t }}</h2>
          <div class="my-4 py-4">
            {%- assign empty_button_text = 'cart.empty_button' | t -%}
            {% render 'btn-brown', text: empty_button_text, url: routes.all_products_collection_url %}
          </div>
        </div>
      </div>
    {% endif %}
  </div>
{% endform %}

<script>
  window.themeCart = {
    moneyFormat: {{ shop.money_format | json }},
    locale: {{ shop.locale | default: 'lv' | json }},
    currency: {{ shop.currency | json }},
    freeShippingThresholdCents: {{ section.settings.free_shipping_threshold | default: 0 | times: 100 | round }},
    flatShippingCents: {{ section.settings.flat_shipping | default: 0 | times: 100 | round }},
    initialCartTotalCents: {{ cart.total_price }}
  };
</script>
<script src="{{ 'cart-update.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "t:general.cart",
  "settings": []
}
{% endschema %}

<template id="empty-cart-template">
  <div class="h-60 md:h-120 mx-auto flex items-center justify-center">
    <div class="text-center">
      <h2 class="text-3xl my-4">{{ 'cart.empty' | t }}</h2>
      <div class="my-4 py-4">
        {% render 'btn-brown', text: 'cart.empty_button' | t, url: routes.all_products_collection_url %}
      </div>
    </div>
  </div>
</template>
