{% form 'cart', cart %}
  <div class="container mx-auto px-4 pt-24 pb-12">
    {% if cart.item_count > 0 %}
      <div data-cart-body>
        {%- assign back_to_store_text = 'cart.back_to_store' | t -%}
        {% render 'btn-brown', url: routes.all_products_collection_url, text: back_to_store_text %}
        <div class="flex items-center justify-between mb-6">
          <h1 class="hidden">{{ 'cart.heading' | t }}</h1>
        </div>

        <div class="overflow-x-auto md:overflow-visible">
          <table class="w-full table-auto border-separate border-spacing-y-12">
            <thead class="text-left shadow-md hidden md:table-header-group">
              <tr>
                <th class="px-6 py-3">{{ 'cart.product' | t }}</th>
                <th class="px-6 py-3 text-center">{{ 'cart.price' | t }}</th>
                <th class="px-6 py-3 text-center">{{ 'cart.quantity' | t }}</th>
                <th class="px-6 py-3 text-right">{{ 'cart.subtotal' | t }}</th>
              </tr>
            </thead>

            <tbody class="block md:table-row-group">
              {% for item in cart.items %}
                <tr
                  class="relative overflow-hidden block md:table-row shadow-lg rounded-lg mb-4 md:mb-0 p-2 md:p-0 cart-line-item border border-gray-200 md:border-0"
                  data-key="{{ item.key }}"
                  data-max="{{ item.variant.inventory_quantity | default: 9999 }}"
                >
                  <!-- Product -->
                  <td class="block md:table-cell px-6 py-4">
                    <div class="flex items-center gap-4">
                      {% render 'btn-remove-product', item: item %}
                      <a href="{{ item.url }}" class="flex items-center gap-4">
                        <img
                          src="{{ item.image | image_url: width: 100 }}"
                          alt="{{ item.product.title }}"
                          width="100"
                          height="100"
                          class="rounded"
                        >
                        <div class="flex flex-col">
                          <p class="font-medium">{{ item.product.title | truncatewords: 3 }}</p>
                          {% if item.variant and item.variant.title != 'Default Title' %}
                            <p class="text-xs text-gray-500 mt-1">
                              {{ item.variant.title }}
                            </p>
                          {% endif %}
                        </div>
                      </a>
                    </div>
                    <div class="mt-2 min-h-5">
                      <div
                        data-error
                        class="text-base text-red-600 text-left max-w-[320px] opacity-0 transition-opacity duration-300"
                      ></div>
                    </div>
                  </td>

                  <!-- Price with discount -->
                  <td class="block md:table-cell px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between md:block">
                      <span class="md:hidden">{{ 'cart.price' | t }}</span>
                      <div class="text-right md:text-center">
                        {%- if item.variant.compare_at_price > item.variant.price -%}
                          <div class="flex flex-col items-end md:items-center gap-1">
                            <span class="font-semibold text-sp-brown">{{ item.price | money }}</span>
                            <span class="text-xs line-through opacity-60">
                              {{- item.variant.compare_at_price | money -}}
                            </span>
                          </div>
                        {%- else -%}
                          <span>{{ item.price | money }}</span>
                        {%- endif -%}
                      </div>
                    </div>
                  </td>

                  <!-- Quantity -->
                  <td class="block md:table-cell px-6 py-4 border-b border-gray-200">
                    <div class="flex items-center justify-between md:block">
                      <span class="md:hidden">{{ 'cart.quantity' | t }}</span>
                      <div class="quantity-container flex justify-end md:justify-center">
                        <div class="inline-flex items-center border rounded-2xl overflow-hidden w-fit">
                          <a
                            href="{{ routes.cart_change_url }}?line={{ forloop.index }}&quantity={{ item.quantity | minus: 1 }}"
                            class="link--no-underline quantity__button button quantity-minus px-2.5 py-1.5 hover:bg-sp-light-brown transition-colors cursor-pointer"
                            >âˆ’</a
                          >
                          <span data-qty class="w-8 text-center py-1.5 font-bold">{{ item.quantity }}</span>
                          <a
                            href="{{ routes.cart_change_url }}?line={{ forloop.index }}&quantity={{ item.quantity | plus: 1 }}"
                            class="link--no-underline quantity__button button quantity-plus px-2.5 py-1.5 hover:bg-sp-light-brown transition-colors cursor-pointer"
                            >+</a
                          >
                        </div>
                      </div>
                    </div>
                  </td>

                  <!-- Subtotal with discount -->
                  <td class="block md:table-cell px-6 py-4 text-right" data-line-price>
                    <div class="flex justify-between md:block">
                      <span class="md:hidden">{{ 'cart.subtotal' | t }}</span>
                      <div>
                        {%- assign line_compare_price = item.variant.compare_at_price | times: item.quantity -%}
                        {%- if item.variant.compare_at_price > item.variant.price -%}
                          <div class="flex flex-col items-end gap-1">
                            <span data-line-price-amount class="font-semibold text-sp-brown">
                              {{- item.final_line_price | money -}}
                            </span>
                            <span class="text-xs line-through opacity-60">{{ line_compare_price | money }}</span>
                          </div>
                        {%- else -%}
                          <span data-line-price-amount>{{ item.final_line_price | money }}</span>
                        {%- endif -%}
                      </div>
                    </div>

                    <!-- Row overlay -->
                    <div
                      data-row-overlay
                      class="hidden absolute inset-0 bg-white/60 z-10 flex items-center justify-center"
                      aria-hidden="true"
                    >
                      <span
                        class="inline-block h-4 w-4 rounded-full border-2 border-sp-brown border-t-transparent animate-spin"
                      ></span>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
          <p class="text-gray-400">{{ 'cart.discount_note' | t }}</p>
        </div>

        <div id="cart-total" class="flex md:justify-end">
          <div class="text-sp-brown p-6 border-2 border-sp-brown flex flex-col w-full md:max-w-lg">
            <h2 class="text-2xl mb-4 text-sp-brown">{{ 'cart.cart_total' | t }}</h2>

            {%- comment -%} Calculate total savings {%- endcomment -%}
            {%- assign total_savings = 0 -%}
            {%- for item in cart.items -%}
              {%- if item.variant.compare_at_price > item.variant.price -%}
                {%- assign item_savings = item.variant.compare_at_price
                  | minus: item.variant.price
                  | times: item.quantity
                -%}
                {%- assign total_savings = total_savings | plus: item_savings -%}
              {%- endif -%}
            {%- endfor -%}

            <div class="flex justify-between border-b border-sp-brown py-4">
              <p>{{ 'cart.subtotal' | t }}:</p>
              <p data-subtotal-amount>{{ cart.total_price | money }}</p>
            </div>

            {%- if total_savings > 0 -%}
              <div class="flex justify-between border-b border-sp-brown py-4 text-sp-brown">
                <p>{{ 'cart.discount' | t }}:</p>
                <p class="font-semibold">-{{ total_savings | money }}</p>
              </div>
            {%- endif -%}

            {% comment %}
              <div class="flex justify-between border-b border-sp-brown py-4">
                <p>{{ 'cart.shipping' | t }}:</p>
                <p data-shipping-amount data-free-label="Bezmaksas"></p>
              </div>
            {% endcomment %}

            <div class="flex justify-between py-4">
              <p>{{ 'cart.total' | t }}:</p>
              <p data-grandtotal-amount>{{ cart.total_price | money }}</p>
            </div>
            {%- assign checkout_text = 'cart.continue_to_checkout' | t -%}
            <div class="flex justify-center">
              {% render 'btn-brown-submit', text: checkout_text, name: 'checkout' %}
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <div class="h-60 md:h-120 mx-auto flex items-center justify-center">
        <div class="text-center">
          <h2 class="text-3xl my-4">{{ 'cart.empty' | t }}</h2>
          <div class="my-4 py-4">
            {% render 'btn-brown', text: 'cart.empty_button' | t, url: routes.all_products_collection_url %}
          </div>
        </div>
      </div>
    {% endif %}
  </div>
{% endform %}

<script>
  window.themeCart = {
    moneyFormat: {{ shop.money_format | json }},
    locale: {{ shop.locale | default: 'lv' | json }},
    currency: {{ shop.currency | json }},
    {% comment %} freeShippingThresholdCents: {{ section.settings.free_shipping_threshold | default: 0 | times: 100 | round }}, {% endcomment %}
    {% comment %} flatShippingCents: {{ section.settings.flat_shipping | default: 0 | times: 100 | round }}, {% endcomment %}
    initialCartTotalCents: {{ cart.total_price }}
  };
</script>
<script src="{{ 'cart-update.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "t:general.cart",
  "settings": []
}
{% endschema %}

{% comment %}
  Insert the below settings if needed.
  {
   "type": "text",
   "id": "free_shipping_threshold",
   "label": "Free shipping from (e.g. 50.00)",
   "default": "0"
   },
   {
     "type": "text",
     "id": "flat_shipping",
     "label": "Flat delivery fee (e.g. 2.99)",
     "default": "0"
   }
{% endcomment %}

<template id="empty-cart-template">
  <div class="h-60 md:h-120 mx-auto flex items-center justify-center">
    <div class="text-center">
      <h2 class="text-3xl my-4">{{ 'cart.empty' | t }}</h2>
      <div class="my-4 py-4">
        {% render 'btn-brown', text: 'cart.empty_button' | t, url: routes.all_products_collection_url %}
      </div>
    </div>
  </div>
</template>
