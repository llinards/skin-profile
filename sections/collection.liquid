{% comment %}
  This section is used in the collection template to render collection page
  listing all products within a collection.
  https://shopify.dev/docs/storefronts/themes/architecture/templates/collection
{% endcomment %}
<div
  class="container mx-auto px-4 pb-12 relative"
  x-data="collectionPagination()"
  x-init="init()"
>
  <h2 class="pb-12">{{ collection.title | default: 'Produkti' }}</h2>

  {% paginate collections.all.products by 4 %}
    <!-- Collection-only loading overlay -->
    <div
      x-show="loading"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-300"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="absolute inset-x-0 top-24 bottom-0 bg-white bg-opacity-90 flex items-center justify-center z-10 rounded-lg"
      style="display: none;"
    >
      <div class="flex flex-col items-center space-y-4">
        <div class="loading-spinner"></div>
        <p>Ielādē...</p>
      </div>
    </div>

    <!-- Product grid wrapper for relative positioning -->
    <div class="relative">
      <!-- Product grid -->
      <div
        class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 transition-opacity duration-300"
        x-ref="productGrid"
        :class="{ 'opacity-30': loading }"
      >
        {% for product in collections.all.products %}
          <div class="flex flex-col product-card">
            {% if product.featured_image %}
              {% render 'image',
                image: product.featured_image,
                url: product.url,
                width: 400,
                height: 400,
                class: 'product-image'
              %}
            {% endif %}
            <div class="flex flex-col space-y-3 items-center justify-center p-4">
              <h3 class="body-font text-center text-sm font-bold">{{ product.title | escape }}</h3>
              <p class="font-semibold text-lg">{{ product.price | money }}</p>

              <form action="{{ routes.cart_add_url }}" method="post" enctype="multipart/form-data">
                <input type="hidden" name="id" value="{{ product.first_available_variant.id }}">
                {% if product.available %}
                  <button type="submit" class="btn-add-to-cart" :disabled="loading">
                    {{ 'products.add_to_cart' | t | default: 'Add to Cart' }}
                  </button>
                {% else %}
                  <button type="button" disabled class="btn-sold-out">
                    {{ 'products.sold_out' | t | default: 'Sold Out' }}
                  </button>
                {% endif %}
              </form>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Pagination with loading state -->
      {% if paginate.pages > 1 %}
        <div
          class="flex flex-row justify-center transition-opacity duration-300 mt-8"
          x-ref="pagination"
          :class="{ 'opacity-30 pointer-events-none': loading }"
        >
          {% render 'paginate', paginate: paginate %}
        </div>
      {% endif %}
    </div>
  {% endpaginate %}
</div>

{% stylesheet %}
  /* Loading spinner animation */
  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #885642;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  /* Product card animations */
  .product-card {
    transition: transform 0.2s ease, opacity 0.3s ease;
  }

  .product-card:hover:not(.loading) {
    transform: translateY(-2px);
  }

  /* Button styles */
  .btn-add-to-cart {
    @apply bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors duration-200 w-full;
  }

  .btn-add-to-cart:disabled {
    @apply opacity-50 cursor-not-allowed;
  }

  .btn-sold-out {
    @apply bg-gray-400 text-white px-6 py-2 rounded-lg cursor-not-allowed w-full;
  }

  /* Loading state for images */
  .product-image {
    transition: opacity 0.3s ease;
  }

  /* Skeleton loader for product cards (optional) */
  .skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }

  @keyframes loading {
    0% {
      background-position: 200% 0;
    }
    100% {
      background-position: -200% 0;
    }
  }
{% endstylesheet %}

{% schema %}
{
  "name": "All Products",
  "settings": [
    {
      "type": "text",
      "id": "custom_title",
      "label": "Custom page title",
      "info": "Leave blank to use 'All Products'"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per page",
      "min": 8,
      "max": 24,
      "step": 4,
      "default": 12
    }
  ]
}
{% endschema %}
