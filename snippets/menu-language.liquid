{%- assign languages = localization.available_languages -%}
{%- if languages.size > 1 -%}
  {%- assign current = localization.language.iso_code -%}
  {%- assign is_mobile = mobile | default: false -%}
  {% if is_mobile %}
    <div
      x-data="
        {
          open: false,
          h: 0,
          toggle() {
            this.open = !this.open;
            this.$nextTick(() => { this.h = this.open ? (this.$refs.panel?.scrollHeight || 0) : 0; });
          }
        }
      "
      class="w-full max-w-sm mx-auto flex flex-col items-center"
    >
      <button
        type="button"
        @click="toggle()"
        class="text-base w-full inline-flex items-center justify-center gap-2 py-2 text-center"
        :aria-expanded="open.toString()"
        aria-haspopup="true"
      >
        <span class="truncate">
          {{ localization.language.endonym_name | capitalize }}
        </span>
        <svg
          class="h-5 w-5 transition-transform duration-200"
          :class="open ? 'rotate-180' : ''"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="1.8"
        >
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>
        </svg>
      </button>
      <div
        x-ref="panel"
        :style="`max-height:${h}px`"
        class="w-full overflow-hidden transition-[max-height] duration-300 ease-out"
        role="region"
        :aria-hidden="(!open).toString()"
      >
        {% form 'localization', id: 'localization_form_mobile' %}
          <ul class="mt-2 space-y-2 list-none text-center bg-sp-light-brown rounded-md py-2">
            {% for locale in languages %}
              <li>
                <a
                  href="#"
                  data-locale="{{ locale.iso_code }}"
                  class="text-base locale-link inline-block px-3 py-2 rounded hover:bg-sp-light-brown transition-all duration-300 {% if locale.iso_code == current %}font-semibold text-sp-brown{% endif %}"
                >
                  {{ locale.endonym_name | capitalize }}
                </a>
              </li>
            {% endfor %}
          </ul>
          <input type="hidden" name="locale_code" value="{{ current }}" id="locale-code-mobile">
        {% endform %}
      </div>
    </div>
  {% else %}
    <div
      x-data="
        {
          isOpen: false,
          t: null,
          enter() { clearTimeout(this.t); this.isOpen = true },
          leave() { this.t = setTimeout(()=> this.isOpen = false,120) }
        }
      "
      @mouseenter="enter()"
      @mouseleave="leave()"
      class="relative"
    >
      <button
        type="button"
        class="text-base xl:text-lg flex lg:text-white items-center py-1 border border-transparent hover:border-b-white transition-all duration-300 whitespace-nowrap {{ invert_class }}"
        :aria-expanded="isOpen.toString()"
        aria-haspopup="true"
      >
        {{ localization.language.endonym_name | capitalize }}
        {% render 'icon-chevron-down' %}
      </button>
      <div
        x-show="isOpen"
        x-transition.opacity.duration.150ms
        class="hidden lg:block absolute left-1/2 -translate-x-1/2 top-full mt-2 z-50"
      >
        <div class="w-40 rounded-md bg-white shadow-xl ring-1 ring-black/5 overflow-hidden">
          {% form 'localization', id: 'localization_form_desktop' %}
            <ul class="py-2 text-center list-none {{ invert_class }}">
              {% for locale in languages %}
                <li class="text-base">
                  <a
                    href="#"
                    data-locale="{{ locale.iso_code }}"
                    class="locale-link block px-3 py-2 text-base hover:bg-sp-light-brown transition-all duration-300 {% if locale.iso_code == current %}font-semibold text-sp-brown{% endif %} {{ invert_class }}"
                  >
                    {{ locale.endonym_name | capitalize }}
                  </a>
                </li>
              {% endfor %}
            </ul>
            <input type="hidden" name="locale_code" value="{{ current }}" id="locale-code-desktop">
          {% endform %}
        </div>
      </div>
    </div>
  {% endif %}

  <script>
    document.querySelectorAll('.locale-link').forEach((item) => {
      item.addEventListener('click', (event) => {
        event.preventDefault();
        const form = item.closest('form');
        const hiddenInput = form.querySelector('input[name="locale_code"]');
        hiddenInput.value = item.getAttribute('data-locale');
        form.submit();
      });
    });
  </script>
{%- endif -%}
