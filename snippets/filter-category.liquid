{%- comment -%}
  This filter manually builds a list from the 'custom.produkta_kategorija' metafield.
  This is the most reliable method and avoids app synchronization issues.
{%- endcomment -%}

{%- assign metafield_param = 'filter.p.metafield.custom.produkta_kategorija' -%}

{%- assign current_category = 'Kategorija' -%}

{%- comment -%} --- Logic to preserve OTHER active filters (like Vendor or Price) --- {%- endcomment -%}
{%- assign other_active_filters = '' -%}
{%- for param in request.query -%}
  {%- if param.first contains 'filter.' and param.first != metafield_param -%}
    {%- for value in param.last -%}
      {%- assign other_active_filters = other_active_filters
        | append: '&'
        | append: param.first
        | append: '='
        | append: value
      -%}
    {%- endfor -%}
  {%- endif -%}
{%- endfor -%}

{%- assign sort_by_param = '' -%}
{%- if request.query.sort_by -%}
  {%- assign sort_by_param = 'sort_by=' | append: request.query.sort_by -%}
{%- endif -%}
{%- comment -%} -------------------------------------------------------------------- {%- endcomment -%}

{%- capture dropdown_content -%}
  {%- comment -%}
    THE FIX IS HERE: Use collection.all_products to prevent breaking the main paginate loop.
  {%- endcomment -%}
  {%- assign collection_meta_values = collection.all_products | map: 'metafields' | map: 'custom' | map: 'produkta_kategorija' | uniq -%}

  <a href="{{ collection.url }}?{{ other_active_filters | remove_first: '&' }}{% if sort_by_param %}&{{ sort_by_param }}{% endif %}" class="block px-4 py-2 text-sm hover:bg-gray-100 transition-colors filter-link">
    Visas kategorijas
  </a>

  {%- for meta_value in collection_meta_values -%}
    {%- if meta_value == blank %}{% continue %}{% endif -%}

    {%- assign is_active = false -%}
    {%- if request.query[metafield_param] == meta_value -%}
      {%- assign is_active = true -%}
      {%- assign current_category = meta_value -%}
    {%- endif -%}

    {%- assign new_url = collection.url
      | append: '?'
      | append: metafield_param
      | append: '='
      | append: meta_value
      | append: other_active_filters
    -%}
    {%- if sort_by_param -%}
      {%- assign new_url = new_url | append: '&' | append: sort_by_param -%}
    {%- endif -%}
    <a
      href="{{ new_url }}"
      class="block px-4 py-2 text-sm hover:bg-gray-100 transition-colors filter-link {% if is_active %}bg-gray-50 font-semibold{% endif %}"
    >
      {{ meta_value }}
    </a>
  {%- endfor -%}
{%- endcapture -%}

{% render 'filter', filter_text: 'Kategorija', current_value: current_category, dropdown_content: dropdown_content %}
