{% assign sort_by = request.query.sort_by | default: collection.sort_by | default: 'manual' %}

{% comment %} Preserve existing filters when adding sort_by {% endcomment %}
{% assign query_params = request.query_string | split: '&' %}
{% assign filter_params = '' %}
{% for param in query_params %}
  {% unless param contains 'sort_by=' %}
    {% if filter_params == '' %}
      {% assign filter_params = param %}
    {% else %}
      {% assign filter_params = filter_params | append: '&' | append: param %}
    {% endif %}
  {% endunless %}
{% endfor %}

{% assign sort_options = 'manual:Ieteicamie,price-ascending:Cena: Augošā,price-descending:Cena: Dilstošā'
  | split: ','
%}

{% assign current_sort = 'Ieteicamie' %}
{% case sort_by %}
  {% when 'price-ascending' %}
    {% assign current_sort = 'Cena: Augošā' %}
  {% when 'price-descending' %}
    {% assign current_sort = 'Cena: Dilstošā' %}
{% endcase %}

{% capture dropdown_content %}
  {% for option in sort_options %}
    {% assign pair = option | split: ':' %}
    {% assign key = pair[0] %}
    {% assign label = pair[1] %}
    
    {% if filter_params != '' %}
      {% assign sort_url = collection.url | append: '?sort_by=' | append: key | append: '&' | append: filter_params %}
    {% else %}
      {% assign sort_url = collection.url | append: '?sort_by=' | append: key %}
    {% endif %}
    
    <a
      href="{{ sort_url }}"
      class="block px-4 py-2 text-sm hover:bg-gray-100 transition-colors filter-link {% if sort_by == key %}bg-gray-50 font-semibold{% endif %}"
    >
      {{ label }}
    </a>
  {% endfor %}
{% endcapture %}

{% render 'filter', filter_text: 'Kārtot', current_value: current_sort, dropdown_content: dropdown_content %}
