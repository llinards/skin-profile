{% assign is_mobile = mobile | default: false %}

{% if is_mobile %}
  {%- assign submenu_id = 'submenu-' | append: link.title | handleize -%}
  <div
    x-data="
      {
        open: false,
        toggle() {
          this.open = !this.open;
        }
      }
    "
    class="w-full max-w-sm mx-auto flex flex-col items-center"
  >
    <button
      type="button"
      @click="toggle()"
      class="text-base lg:text-lg w-full inline-flex items-center justify-center gap-2 py-3 text-center font-medium hover:bg-(--color-brand-secondary)/30 transition-colors duration-200 rounded"
      :aria-expanded="open.toString()"
      :aria-controls="'{{ submenu_id }}'"
      aria-haspopup="true"
    >
      <span class="truncate">{{- link.title -}}</span>
      <svg
        class="h-5 w-5 transition-transform duration-300 ease-in-out"
        :class="open ? 'rotate-180' : ''"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
        stroke-width="2"
        aria-hidden="true"
      >
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>
      </svg>
    </button>

    {% if link.links and link.links.size > 0 %}
      <div
        id="{{ submenu_id }}"
        x-show="open"
        x-collapse
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="w-full"
        role="region"
        :aria-hidden="(!open).toString()"
      >
        <ul class="mt-2 space-y-1 list-none text-center bg-(--color-brand-secondary) rounded-lg py-2 ">
          {% for child in link.links %}
            <li>
              {% if child.links and child.links.size > 0 %}
                {%- assign child_submenu_id = 'submenu-' | append: child.title | handleize -%}
                <!-- Nested dropdown -->
                <div
                  x-data="
                    {
                      childOpen: false,
                      toggleChild() {
                        this.childOpen = !this.childOpen;
                      }
                    }
                  "
                  class="w-full"
                >
                  <button
                    type="button"
                    @click="toggleChild()"
                    class="text-base lg:text-lg w-full inline-flex items-center justify-center gap-2 px-3 py-3 hover:bg-white/30 transition-all duration-200 rounded"
                    :aria-expanded="childOpen.toString()"
                    :aria-controls="'{{ child_submenu_id }}'"
                    aria-haspopup="true"
                  >
                    <span class="truncate">{{ child.title }}</span>
                    <svg
                      class="h-4 w-4 transition-transform duration-300 ease-in-out"
                      :class="childOpen ? 'rotate-180' : ''"
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="2"
                      aria-hidden="true"
                    >
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </button>

                  <div
                    id="{{ child_submenu_id }}"
                    x-show="childOpen"
                    x-collapse
                    x-transition:enter="transition ease-out duration-300"
                    x-transition:enter-start="opacity-0 transform scale-95"
                    x-transition:enter-end="opacity-100 transform scale-100"
                    x-transition:leave="transition ease-in duration-200"
                    x-transition:leave-start="opacity-100 transform scale-100"
                    x-transition:leave-end="opacity-0 transform scale-95"
                    class="w-full"
                    role="region"
                    :aria-hidden="(!childOpen).toString()"
                  >
                    <ul class="mt-2 space-y-1 list-none text-center bg-(--color-brand-secondary)-opacity rounded-lg py-2 mx-3 ">
                      {% for grandchild in child.links %}
                        <li>
                          <a
                            href="{{ grandchild.url }}"
                            class="inline-block w-full px-3 py-2 text-base lg:text-lg hover:bg-white/30 transition-all duration-200 rounded"
                          >
                            {{ grandchild.title }}
                          </a>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              {% else %}
                <!-- Simple link without children -->

                <a
                  href="{{ child.url }}"
                  class="
                    inline-block w-full px-3 py-3 text-base lg:text-lg hover:bg-white/30 transition-all
                    duration-200 rounded
                  "
                >
                  {{ child.title }}
                </a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </div>
{% else %}
  <div
    x-data="
      {
        isOpen: false,
        activeChild: null,

        panelStyle: '',

        openMain() {
          this.isOpen = true;
          // Wait for Alpine to render, then for browser paint
          this.$nextTick(() => {
            requestAnimationFrame(() => {
              this.positionPanel();
            });
          });
        },

        closeMain() {
          this.isOpen = false;
          this.activeChild = null;
        },

        openChild(i) { this.activeChild = i },

        positionPanel() {
          const trigger = this.$refs.trigger;
          const panel = this.$refs.panel;

          if (!trigger || !panel) return;

          // Force a reflow to ensure dimensions are accurate
          panel.offsetHeight;

          // Find the nearest container to clamp within
          const container = trigger.closest('.container');
          const c = container ? container.getBoundingClientRect() : document.documentElement.getBoundingClientRect();
          const t = trigger.getBoundingClientRect();

          const panelWidth = panel.offsetWidth;

          // Center panel to trigger, then clamp inside container bounds
          const desiredLeft = t.left + (t.width / 2) - (panelWidth / 2);
          const left = Math.min(Math.max(desiredLeft, c.left), c.right - panelWidth);

          // Match Tailwind mt-2 (~8px)
          const top = t.bottom + 8;

          this.panelStyle = `left:${Math.round(left)}px; top:${Math.round(top)}px;`;
        }
      }
    "
    @mouseenter="openMain()"
    @mouseleave="closeMain()"
    @resize.window="isOpen && positionPanel()"
    class="relative"
  >
    <a
      x-ref="trigger"
      href="{{ link.url }}"
      class="flex lg:text-white text-base xl:text-lg items-center py-1 border border-transparent hover:border-b-white transition-all duration-300 whitespace-nowrap {{ invert_class }}"
      aria-haspopup="true"
      :aria-expanded="isOpen.toString()"
    >
      {{ link.title }}
      {% render 'icon-chevron-down' %}
    </a>

    {% if link.links and link.links.size > 0 %}
      <!-- FIRST PANEL (main children) -->
      <div
        x-ref="panel"
        x-show="isOpen"
        x-transition:enter="transition ease-out duration-150"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="hidden lg:block fixed z-50"
        style="display: none;"
        :style="panelStyle"
      >
        <div class="relative flex rounded-md bg-white shadow-xl ring-1 ring-black/5 overflow-visible">
          <!-- LEFT SIDE — Level 1 -->
          <ul class="py-2 text-center list-none min-w-[200px]">
            {% for child in link.links %}
              <li
                @mouseenter="openChild({{ forloop.index0 }})"
                class="relative group w-full"
                x-ref="item{{ forloop.index0 }}"
              >
                <a
                  href="{{ child.url }}"
                  class="wrap-break-word w-full justify-between flex items-center px-6 py-2 text-base hover:bg-(--color-brand-secondary) transition-colors duration-300 whitespace-nowrap"
                >
                  {{ child.title }}
                  {% if child.links and child.links.size > 0 %}
                    {% render 'icon-chevron-down', class: 'rotate-270' %}
                  {% endif %}
                </a>
              </li>
            {% endfor %}
          </ul>

          <!-- RIGHT SIDE — Level 2 (child.links) -->
          {% for child in link.links %}
            {% if child.links and child.links.size > 0 %}
              <ul
                x-show="activeChild === {{ forloop.index0 }}"
                x-transition:enter="transition ease-out duration-150"
                x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                class="absolute left-full -ml-2 bg-white shadow-xl ring-1 ring-black/5 py-2 min-w-[200px] text-center rounded-md list-none transition-all duration-150"
                x-init="$watch('activeChild', value => { if(value === {{ forloop.index0 }}) { $el.style.top = $refs.item{{ forloop.index0 }}.offsetTop + 'px' } })"
                style="display: none;"
              >
                {% for sub in child.links %}
                  <li>
                    <a
                      href="{{ sub.url }}"
                      class="block px-6 py-2 text-base hover:bg-(--color-brand-secondary) transition-colors duration-300 whitespace-nowrap"
                    >
                      {{ sub.title }}
                    </a>
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>
{% endif %}
