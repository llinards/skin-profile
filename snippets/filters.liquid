{%- comment -%} Regular Filters {%- endcomment -%}
{% for filter in collection.filters %}
  {% if filter.type == 'list' or filter.type == 'price_range' %}
    {%- assign current_value = filter.label -%}
    {%- if filter.active_values.size > 0 -%}
      {%- assign current_value = filter.active_values.first.label -%}
    {%- endif -%}

    {%- comment -%} Build base URL preserving OTHER filters and sort_by {%- endcomment -%}
    {%- assign base_params = '' -%}
    {%- for other_filter in collection.filters -%}
      {%- if other_filter.param_name != filter.param_name and other_filter.active_values.size > 0 -%}
        {%- for active_value in other_filter.active_values -%}
          {%- assign base_params = base_params
            | append: '&'
            | append: active_value.param_name
            | append: '='
            | append: active_value.value
          -%}
        {%- endfor -%}
      {%- endif -%}
    {%- endfor -%}

    {%- comment -%} IMPORTANT: Always append sort_by at the end - use collection.sort_by instead {%- endcomment -%}
    {%- if collection.sort_by -%}
      {%- assign base_params = base_params | append: '&sort_by=' | append: collection.sort_by -%}
    {%- endif -%}

    {%- comment -%} Build dropdown content {%- endcomment -%}
    {%- capture dropdown_content -%}
      {%- comment -%} "Clear this filter" option {%- endcomment -%}
      <a href="{{ collection.url }}?{{ base_params | remove_first: '&' }}" class="block px-4 py-2 text-sm hover:bg-gray-100 transition-colors filter-link {% if filter.active_values.size == 0 %}bg-gray-50 font-semibold{% endif %}">
        {% if filter.label == 'Ražotājs' %}
          Visi ražotāji
        {% else %}
          Visas kategorijas
        {% endif %}
      </a>

      {%- comment -%} Filter values - each gets cleaned URL with THIS selection + other filters + sort {%- endcomment -%}
      {%- for value in filter.values -%}
        {%- assign single_select_url = collection.url | append: '?' | append: value.param_name | append: '=' | append: value.value | append: base_params -%}
        <a
          href="{{ single_select_url }}"
          class="block px-4 py-2 text-sm hover:bg-gray-100 transition-colors filter-link {% if value.active %}bg-gray-50 font-semibold{% endif %}"
        >
          {{ value.label }} <span class="text-gray-500 text-xs">({{ value.count }})</span>
        </a>
      {%- endfor -%}
    {%- endcapture -%}

    {% render 'filter-dropdown',
      filter_text: filter.label,
      current_value: current_value,
      dropdown_content: dropdown_content
    %}
  {% endif %}
{% endfor %}

{%- assign sort_options = 'manual,best-selling,title-ascending,title-descending,price-ascending,price-descending,created-ascending,created-descending'
  | split: ','
-%}
{%- assign sort_labels = 'Kārtot pēc,Populārākie,Nosaukums: A-Z,Nosaukums: Z-A,Cena: Augošā,Cena: Dilstošā,Vecākais,Jaunākais'
  | split: ','
-%}
{%- assign selected_sort_key = collection.sort_by | default: collection.default_sort_by -%}

{%- assign filter_params = '' -%}
{%- for filter in collection.filters -%}
  {%- for value in filter.active_values -%}
    {%- assign filter_params = filter_params
      | append: '&'
      | append: value.param_name
      | append: '='
      | append: value.value
    -%}
  {%- endfor -%}
{%- endfor -%}

{%- capture dropdown_content -%}
  {%- for option in sort_options -%}
    {%- assign sort_url = collection.url | append: '?sort_by=' | append: option | append: filter_params -%}
    <a
      href="{{ sort_url }}"
      class="block px-4 py-2 text-sm hover:bg-gray-100 transition-colors filter-link {% if selected_sort_key == option %}bg-gray-50 font-semibold{% endif %}"
    >
      {{ sort_labels[forloop.index0] }}
    </a>
  {%- endfor -%}
{%- endcapture -%}

{% render 'filter-dropdown',
  filter_text: 'Kārtot pēc',
  current_value: 'Kārtot pēc',
  label_id: 'sort-by-label',
  dropdown_content: dropdown_content
%}
